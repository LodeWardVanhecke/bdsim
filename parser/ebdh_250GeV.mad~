  TITLE, "High Energy e- Beam Delivery System (NLC2003)"

  OPTION, -INTER, -ECHO, VERIFY, DOUBLE
  ASSIGN, PRINT="ebdh_250GeV.print"
  ASSIGN, ECHO="ebdh_250GeV.echo"

! ==============================================================================
! Load intial conditions and common definitions
! ------------------------------------------------------------------------------

  CALL, FILENAME="nlc000.nlc_common.xsif"
  CALL, FILENAME="ebdh_250GeV_initial.xsif"
  CALL, FILENAME="nlc040.bds_common.xsif"

! ==============================================================================
! Load beamline definitions
! ------------------------------------------------------------------------------

  CALL, FILENAME="nlc601.ebsy.xsif"
  CALL, FILENAME="nlc611.eirth.xsif"
  CALL, FILENAME="nlc612.effh.xsif"
  CALL, FILENAME="nlc614.edlh.xsif"

! ==============================================================================
! Input beam definitions
! ------------------------------------------------------------------------------

! set up TWSS0

  TWSS0  : BETA0,&
           ENERGY=Ef, BETX=TBETX, ALFX=TALFX, BETY=TBETY, ALFY=TALFY

! construct input beam matrix (assumes DY=DPY=0)

  EMITX := EMITXN/(TWSS0[ENERGY]/EMASS) 
  EMITY := EMITYN/(TWSS0[ENERGY]/EMASS) 
  TGAMX := (1+TWSS0[ALFX]*TWSS0[ALFX])/TWSS0[BETX]
  TGAMY := (1+TWSS0[ALFY]*TWSS0[ALFY])/TWSS0[BETY]
  SIG11 := EMITX*TWSS0[BETX]
  SIG21 := -EMITX*TWSS0[ALFX]
  SIG22 := EMITX*TGAMX
  SIG33 := EMITY*TWSS0[BETY]
  SIG43 := -EMITY*TWSS0[ALFY]
  SIG44 := EMITY*TGAMY
  SIG66 := ESPRD*ESPRD
  C21   := SIG21/SQRT(SIG11*SIG22)
  C43   := SIG43/SQRT(SIG33*SIG44)
  SIG0  : SIGMA0, SIGX=SQRT(SIG11), SIGPX=SQRT(SIG22), R21=C21, &
                  SIGY=SQRT(SIG33), SIGPY=SQRT(SIG44), R43=C43, &
                  SIGT=BLENG, SIGPT=ESPRD

  VALUE, Ef,EMITXN,EMITYN
  VALUE, EMITX,EMITY
  VALUE, 1.E6*SQRT(SIG11),1.E6*SQRT(SIG22),1.E6*SQRT(SIG33),1.E6*SQRT(SIG44)
  VALUE, C21,C43

  BEAM, PARTICLE=ELECTRON, ENERGY=TWSS0[ENERGY], EX=EMITX, EY=EMITY, &
        SIGT=BLENG, SIGE=ESPRD

! ==============================================================================
! COMMANDs
! ------------------------------------------------------------------------------

  SETPLOT, XSIZE=25.4, YSIZE=20.32
  OPTION, ECHO

! generate output files and plots

  USE, (EBSY,EIRTH,EFFH,EDLH)
  PRINT, FULL
  SELECT, OPTICS, FULL
  SAVEBETA, TWSSFF, BEGEFFH
  SAVEBETA, TWSSIP, IP
 

  !TWISS, BETA0 = TWSS0,&
  !       SAVE, TAPE="ebdh_250GeV_twiss.tape"
  TWISS,ENERGY=Ef,BETX=TBETX,ALFX=TALFX,BETY=TBETY,ALFY=TALFY,SAVE=TWISS

  ENVELOPE, SIGMA0=SIG0, SAVE, TAPE="ebdh_250GeV_envelope.tape"

  !OPTICS,ENERGY=Ef,BETX=TBETX,ALFX=TALFX,BETY=TBETY,ALFY=TALFY,&
  !       COLUMNS=NAME,KEYWORD,S,L,K0L,K1L,K2L,K3L,K4L,TILT,TYPE

  PRINT,FULL
  SELECT,OPTICS,FULL

  OPTICS,ENERGY=Ef,BETX=TBETX,ALFX=TALFX,BETY=TBETY,ALFY=TALFY,&
         COLUMNS=NAME,S,BETX,BETY,FILENAME="opt"


 !PLOT, TABLE=TWISS,HAXIS=S,&
 !    VAXIS1=RBETX,RBETY, VAXIS2=DX, STYLE=100, &
 !   SPLINE=.T., TITLE="NLC2003 500 GeV cm"
 PLOT, TABLE=ENVELOPE, HAXIS=S, VAXIS=SIGX, STYLE=100, SPLINE=.T., &
   TITLE="NLC2003 500 GeV cm: <G>ge<G><?>x<?>=3.6x10<!>-6<!> m"
 PLOT, TABLE=ENVELOPE, HAXIS=S, VAXIS=SIGY, STYLE=100, SPLINE=.T., &
   TITLE="NLC2003 500 GeV cm: <G>ge<G><?>y<?>=4.0x10<!>-8<!> m"
 PLOT, TABLE=TWISS, HAXIS=S, VAXIS1=BETX,VAXIS2=BETY, STYLE=100, &
    RANGE=EBSY, TITLE="Skew Correction & Diagnostics"
 PLOT, TABLE=TWISS, HAXIS=S, VAXIS=BETX,BETY, STYLE=100, SPLINE=.T., &
    RANGE=EIRTH, TITLE="High Energy IR Transport"
 PLOT, TABLE=TWISS, HAXIS=S, VAXIS1=BETX,BETY, VAXIS2=DX, STYLE=100, &
    SPLINE=.T., RANGE=EFFH, TITLE="Full Raimondi/Seryi Compact FF"
 PLOT, TABLE=TWISS, HAXIS=S, VAXIS1=BETX,BETY, VAXIS2=DX, STYLE=100, &
    SPLINE=.T., RANGE=EDLH, TITLE="Dump Line"

  

! display twiss at start of FF and at IP
! (NOTE: FF optics has been optimized for maximum luminosity using tracking,
!        GuineaPig, etc. ... first order IP twiss will not be the nominal
!        8 x 0.11 mm)

  VALUE, TWSSFF[ENERGY]
  VALUE, TWSSFF[BETX],TWSSFF[ALFX],TWSSFF[DX],TWSSFF[DPX]
  VALUE, TWSSFF[BETY],TWSSFF[ALFY]

  VALUE, TWSSIP[ENERGY]
  VALUE, TWSSIP[BETX],TWSSIP[ALFX],TWSSIP[DX],TWSSIP[DPX]
  VALUE, TWSSIP[BETY],TWSSIP[ALFY]

! create survey

 !SET, LEGEOH, 0
 !VALUE, LEGEOH

  Xi     := 20.309745091569
  Zi     := -1.981352044465E3
  THETAi := -0.90115187067E-2
  VALUE, Xi,Zi,THETAi

  !USE, (EBSY,EIRTH,EFFH,EDLH)
  !PRINT, FULL
  !SURVEY, X0=Xi, Z0=Zi, THETA0=THETAi, TAPE="ebdh_250GeV_survey.tape"

  STOP
